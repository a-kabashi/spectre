import psycopg2
import pymongo
from pymongo import MongoClient
import datetime

# postgres connection
conn = psycopg2.connect(
    dbname="spectre",
    user="postgres",
    password="123456789",
    host="localhost",
    port="5432"
)

# Mongodb connection
client = MongoClient("mongodb+srv://ak:cO861EI5Kpfy6k2R@cluster0.jscsiwg.mongodb.net/")
db = client.Spectre
agents = db.agents

i = 0

while i <= 10000:
    query = f"SELECT * FROM contacts where acode = {i}"
    cur = conn.cursor()
    cur.execute(query)
    rows = cur.fetchall()
    contacts = []
	
    for row in rows:
        filter_criteria = {"acode": row[0]}
		
        if row[7]:
            doc = {
                   "phone": row[1], "email": row[2], "address_line 1": row[3], "city": row[4],
                   "country": row[5], "from_date": f'{row[6].year}-{row[6].month}-{row[6].day}',
                   "to_date": f'{row[7].year}-{row[7].month}-{row[7].day}'
                  }
            contacts.append(doc)
        else:
            doc = {
                   "phone": row[1], "email": row[2], "address_line 1": row[3], "city": row[4],
                   "country": row[5], "from_date": f'{row[6].year}-{row[6].month}-{row[6].day}',
                   "to_date": row[7]
                  }
            contacts.append(doc)
        
    if contacts:
        new_contacts = {"$set": {'contacts': contacts}}
        agents.update_one(filter_criteria, new_contacts)
		
    i = i+1

cur.close()                                                           
conn.close()
client.close()
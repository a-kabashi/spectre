import pymongo
from pymongo import MongoClient
from neo4j import GraphDatabase

#Neo4j connection
#
#
#Define the URI, username, and password for your Neo4j database
uri = "bolt://localhost:7687"
username = "neo4j"
password = "123456789"

# Create a connection to the database
driver = GraphDatabase.driver(uri, auth=(username, password))


# Mongodb Connection
#
#
client = MongoClient("mongodb+srv://ak:cO861EI5Kpfy6k2R@cluster0.jscsiwg.mongodb.net/")
db = client.Spectre
agents = db.agents  

# Function for run()
def run_query(query, para):
    with driver.session() as session:
        result = session.run(query, para)
        return result
		
# retrieve the data from Mongodb DB
docs = agents.find(projection=projection)
projection = {'acode' : 1, 'skills': 1}

for doc in docs:
    if "skills" in doc:
        #print(doc["acode"])
        for s in doc['skills']:
            query = '''
                           MATCH (a:Agent{acode:$acode})
                           MERGE (a)-[r:has{skill_type: $skill_type, skill_level: $skill_level}]->(s:skill)
                           RETURN a, r, s
                    ''' 
            para = {'acode': doc['acode'], 'skill_type': s['skill_type'], 'skill_level': s['skill_level']}
            print(run_query(query,para))

driver.close()
client.close()